
# Kubernetes Penetration Test: ConfigMap Sensitive Data Exposure

## 1. Overview Section

**Vulnerability Description:**

This vulnerability involves the exposure of sensitive information stored within Kubernetes ConfigMaps. ConfigMaps are designed to store non-confidential configuration data, such as connection strings, endpoint URLs, and other settings. However, it is a common mistake for developers to inadvertently store secrets, passwords, API keys, or other sensitive credentials directly within ConfigMaps. This exposes these secrets to anyone with the appropriate RBAC permissions to view the ConfigMap.

**Attack Vector Description:**

An attacker with read access to a ConfigMap can retrieve and use the sensitive information stored within. This access can be achieved through compromised credentials, successful privilege escalation within the cluster, or misconfigured RBAC policies that grant overly permissive access to ConfigMaps. The attacker can then use the leaked secrets to gain unauthorized access to external systems, escalate privileges further within the cluster, or compromise the application's data and functionality.

**Potential Impact and Consequences:**

The potential impact of this vulnerability is significant, ranging from data breaches to complete system compromise. Consequences can include:

*   **Data Breach:** Compromised database credentials within a ConfigMap could lead to unauthorized access and exfiltration of sensitive data.
*   **Privilege Escalation:** API keys or service account tokens found in a ConfigMap could be used to gain higher-level permissions within the cluster, leading to further compromise.
*   **Application Compromise:** Access keys to third-party services (e.g., AWS S3, Azure Storage) could allow an attacker to manipulate application data or disrupt service availability.
*   **Lateral Movement:** SSH keys stored in a ConfigMap could be used to access other machines or resources within the network.

**Risk Level Assessment:**

*   **Severity:** High
*   **Likelihood:** Medium (depending on RBAC configuration and development practices)
*   **Overall Risk:** High

**Technical Explanation:**

Kubernetes ConfigMaps are inherently *not* intended for storing secrets. They are stored unencrypted within the etcd database and are accessible to anyone with sufficient RBAC permissions. The vulnerability exists when developers or administrators incorrectly use ConfigMaps to store sensitive data instead of using Kubernetes Secrets, which offer encryption at rest and better access control mechanisms.

**Prerequisites and Conditions Needed:**

*   A Kubernetes cluster with one or more ConfigMaps.
*   A user account with sufficient RBAC permissions to list and read ConfigMaps within the target namespace(s).  Typically `get` and `list` permissions on `configmaps` are required.
*   A basic understanding of `kubectl` and Kubernetes concepts.

## 2. Validation and Exploitation Steps Section

**Phase 1: Validation - Discovering ConfigMaps and Assessing Access**

1.  **Listing all ConfigMaps:**

    ```bash
    kubectl get configmaps --all-namespaces
    ```

    **Explanation:** This command lists all ConfigMaps in all namespaces within the cluster.

    **Why:**  We're starting by identifying all potential targets.

    **Expected Output:** A table listing ConfigMaps, their namespace, and age.

    ```
    NAMESPACE     NAME                      DATA   AGE
    default       my-app-config             2      2d
    kube-system   kube-root-ca.crt          1      30d
    dev           database-credentials       1      1h
    ```

    **Look For:**  Any ConfigMaps with names that suggest sensitive information (e.g., `secrets`, `credentials`, `database`, `api-keys`).

2.  **Checking RBAC permissions:**  (Optional, but highly recommended for comprehensive assessment)

    ```bash
    kubectl auth can-i get configmaps --namespace <namespace>
    ```

    ```bash
    kubectl auth can-i list configmaps --namespace <namespace>
    ```

    **Explanation:** These commands check if the currently logged-in user has the `get` and `list` permissions on ConfigMaps in the specified namespace.  Replace `<namespace>` with a relevant namespace from the previous step.

    **Why:** To determine if you have sufficient permissions to exploit the vulnerability.

    **Expected Output:**  `yes` if the user has the permission, `no` otherwise.

    **Look For:** `yes` for both `get` and `list` permissions on ConfigMaps in namespaces of interest. If you have `list` but not `get`, you can still discover the names of the ConfigMaps but not read their contents directly (although there might be ways around this, such as through application logs).

    **Alternative:** If you suspect you lack permissions, you can try listing and getting ConfigMaps anyway. The error messages will confirm your lack of permissions and may give clues about what permissions you're missing.

3.  **Examining a suspicious ConfigMap:**

    ```bash
    kubectl describe configmap <configmap_name> --namespace <namespace>
    ```

    **Explanation:** This command displays detailed information about a specific ConfigMap.  Replace `<configmap_name>` and `<namespace>` with the appropriate values from the previous steps.

    **Why:** To inspect the data stored within the ConfigMap and identify potential secrets.

    **Expected Output:**  A detailed description of the ConfigMap, including its metadata, labels, and the data it contains.

    **Look For:**  Sensitive data such as passwords, API keys, database connection strings, or any other information that should be treated as a secret.  The data is displayed in plain text.

    ```
    Name:         database-credentials
    Namespace:    dev
    Labels:       <none>
    Annotations:  <none>

    Data
    ====
    database_url:
    ----
    jdbc:postgresql://db.example.com:5432/mydatabase?user=admin&password=supersecretpassword
    ```

    **Variations:** If the ConfigMap contains multiple keys, examine each one carefully.

**Phase 2: Exploitation - Extracting and Using Sensitive Data**

1.  **Extracting the sensitive data (Directly):**

    ```bash
    kubectl get configmap <configmap_name> -n <namespace> -o yaml
    ```

    **Explanation:**  This command retrieves the entire ConfigMap in YAML format.

    **Why:** Provides a complete view of the data, making it easy to extract the necessary information.  Using `-o yaml` or `-o json` makes parsing the output programmatically easier.

    **Expected Output:** A YAML representation of the ConfigMap.

    **Look For:**  The `data` section, which will contain the key-value pairs stored in the ConfigMap. Extract the values corresponding to sensitive keys.

2.  **Extracting the sensitive data (Programmatically - YAML):**

    ```bash
    kubectl get configmap <configmap_name> -n <namespace> -o yaml | yq .data.database_url
    ```

   **Explanation:**  This command retrieves the specified element out of the ConfigMap using `yq` (YAML processor). If `yq` isn't installed, you'll need to install it.
   **Why:** Provides a more refined extraction for automated tasks.
   **Expected output:** The specific value of the `database_url` key.

3. **Using the compromised credentials:**

   Once you have extracted the sensitive information (e.g., the database password), you can use it to connect to the database and potentially gain access to sensitive data. The specific steps will depend on the type of credentials that were compromised. For example, if you found database credentials, you would use a database client to connect to the database and perform queries.  This step is application specific, and depends entirely on what the ConfigMap contained and what services those credentials pertain to. The goal is to demonstrate the impact of the compromised credentials. For example, you might attempt to:
    *   Access the compromised database and extract sensitive data.
    *   Use the API key to access a third-party service and perform unauthorized actions.
    *   Use the credentials to impersonate a user or service.

## Remediation Recommendations:

*   **Never store secrets in ConfigMaps.** Always use Kubernetes Secrets for storing sensitive information. Secrets are stored encrypted at rest in etcd and offer more robust access control mechanisms.
*   **Implement robust RBAC policies.** Restrict access to ConfigMaps based on the principle of least privilege. Only grant access to the ConfigMaps that users or services need to perform their tasks.  Regularly review and audit RBAC configurations.
*   **Use a secret management solution.** Consider using a dedicated secret management solution like HashiCorp Vault or AWS Secrets Manager to manage and store secrets. These solutions offer advanced features like encryption, versioning, and auditing.
*   **Implement secret scanning in CI/CD pipelines.** Use tools to scan code and configuration files for accidentally committed secrets.
*   **Rotate secrets regularly.** Rotate passwords, API keys, and other sensitive credentials on a regular basis to limit the impact of a potential compromise.
*   **Audit ConfigMap usage.** Regularly audit ConfigMap usage to identify any instances where sensitive data is being stored in ConfigMaps.
*   **Use Immutable Infrastructure:** Employ immutable infrastructure practices where configuration is fixed at deployment time, minimizing the need for runtime updates to ConfigMaps and reducing the attack surface.
*   **Educate developers and administrators.** Train developers and administrators on secure coding practices and the importance of storing secrets securely.
