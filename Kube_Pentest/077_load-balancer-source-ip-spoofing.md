
# Kubernetes Load Balancer Source IP Spoofing Vulnerability

## 1. Overview Section

This document details the vulnerability of source IP address spoofing within a Kubernetes environment utilizing a Load Balancer.  An attacker can leverage this vulnerability to bypass security policies, gain unauthorized access, or perform other malicious activities by forging the source IP address of requests hitting the Kubernetes services.

**Attack Vector Description:**

The attacker crafts network packets with a forged source IP address that the Load Balancer forwards to the Kubernetes cluster. If the Kubernetes cluster, or applications running within, rely solely on the Load Balancer's forwarded IP as a trust indicator, the attacker can bypass security measures such as IP whitelists or authentication based on source IP. The attacker doesn't need to directly access the Kubernetes nodes; they interact with the Load Balancer, which then forwards the crafted packets to the cluster.

**Potential Impact and Consequences:**

*   **Bypass of Security Policies:** Attackers can bypass network policies, firewall rules, and other access control mechanisms based on source IP addresses.
*   **Unauthorized Access:**  Gain access to services or resources that are restricted to specific IP ranges.
*   **Data Exfiltration/Modification:** If applications incorrectly trust the forged IP, attackers could potentially exfiltrate or modify sensitive data.
*   **Privilege Escalation:** In some scenarios, the forged IP might grant access to administrative functions or privileged accounts.
*   **Denial of Service (DoS):** Although not the primary impact, an attacker could potentially cause a DoS by flooding the cluster with requests from spoofed IPs, overloading the network or the application servers.

**Risk Level Assessment:**

*   **Critical:** If applications directly use the forwarded (spoofed) IP for authentication or authorization without validation, and the Kubernetes cluster's Network Policies or the Load Balancer itself do not effectively mitigate IP spoofing.
*   **High:** If the application uses the forwarded IP for some access control, but other layers of defense exist (e.g., strong authentication methods), making exploitation more complex.
*   **Medium:** If the Load Balancer or Network Policies significantly reduce the exploitability but do not completely eliminate the risk. For example, if the load balancer can only forward packets from specific networks to the cluster.

**Technical Explanation of Why This Vulnerability Exists:**

The vulnerability arises when:

1.  **The Load Balancer forwards the raw IP address:** The Load Balancer forwards packets directly to the backend Kubernetes nodes without properly validating or sanitizing the source IP address.
2.  **Kubernetes relies on forwarded information:** The Kubernetes cluster (either the Ingress controller, the application, or Network Policies) trusts the IP address provided by the Load Balancer without sufficient verification. Specifically, it does not consider the implications of X-Forwarded-For headers or any other security mechanisms.  If the Kubernetes network policies don't explicitly limit traffic to come from the Load Balancer only and the service within Kubernetes trusts the source IP as the legitimate user, this allows an attacker to spoof any IP address.
3.  **Insufficient Network Policies:**  Kubernetes Network Policies are not configured to restrict incoming traffic to the Load Balancer's IP range, allowing external IPs to directly reach the pods.

**Prerequisites and Conditions Needed:**

*   **Access to the Load Balancer:** The attacker must have the ability to send network packets to the Load Balancer's external IP address.
*   **Kubernetes Cluster with a Load Balancer:**  A Kubernetes cluster configured to expose services via a Load Balancer.
*   **Misconfigured Network Policies/Trusting Application:** Kubernetes Network Policies must be absent or not configured to restrict traffic from outside the cluster's network. The application must trust the incoming source IP address for authentication or authorization.
*   **Understanding of the Network Topology:**  Knowledge of the network configuration, including the Load Balancer's IP address, the Kubernetes service's IP address, and the internal network ranges is helpful.
*   **Tools:** `nmap`, `hping3`, `scapy` or other packet crafting tools are required.

## 2. Validation and Exploitation Steps Section

These steps outline how to validate and exploit the source IP spoofing vulnerability.

**Phase 1: Reconnaissance and Setup**

1.  **Identify the Target Load Balancer IP:**

    ```bash
    kubectl get svc -n <namespace> <service-name> -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
    ```

    This command retrieves the external IP address of the Load Balancer associated with the target service. Replace `<namespace>` and `<service-name>` with the appropriate values for the target service.

    *   **Explanation:** This command uses `kubectl` to query the Kubernetes API and retrieve the Load Balancer IP assigned to the target service.
    *   **Expected Output:** An IP address (e.g., `203.0.113.45`) representing the external IP of the Load Balancer.
    *   **Purpose:**  Knowing the Load Balancer IP is crucial for sending spoofed packets to it.

2.  **Identify a "Trusted" IP Address:**

    Determine an IP address that is considered "trusted" by the application. This might require some reconnaissance, such as:

    *   Analyzing application code or configuration files (if accessible).
    *   Using `kubectl exec` to connect to a pod and check environment variables that define trusted networks.
    *   Observing application logs for patterns related to IP-based access control.
    *   Performing social engineering to obtain this information.

    For this example, let's assume `10.0.0.10` is a trusted IP.  In reality, this is often a valid IP within the cluster's internal network, making it a viable spoofing target.

    *   **Explanation:** This step requires gathering information about the application's security configuration.
    *   **Expected Output:** A valid IP address (e.g., `10.0.0.10`) that the application considers legitimate.
    *   **Purpose:**  Knowing a trusted IP allows the attacker to forge requests as if they are coming from a legitimate source.

3.  **Identify the Service Endpoint (Pod IP and Port):**

    ```bash
    kubectl get endpoints -n <namespace> <service-name> -o jsonpath='{.subsets[0].addresses[0].ip}:{.subsets[0].ports[0].port}'
    ```

    This command retrieves the IP address and port of a pod backing the target service.

    *   **Explanation:** This command queries the Kubernetes API for the endpoint details of the service.
    *   **Expected Output:** An IP address and port combination (e.g., `192.168.1.5:8080`).
    *   **Purpose:** This information is needed to craft the TCP packets to the correct destination.

**Phase 2: Validation (Testing for IP Forwarding)**

4.  **Simple TCP SYN Scan with `nmap` (to Load Balancer)**

    ```bash
    sudo nmap -sS -p 80 --source-port 54321 -e eth0 -S 10.0.0.10 <load_balancer_ip>
    ```

    This command performs a TCP SYN scan against port 80 of the Load Balancer, spoofing the source IP address as `10.0.0.10` and specifying the outbound interface as `eth0`. Replace `eth0` with the correct interface on your system.

    *   **Explanation:** `nmap` is used to send a SYN packet to the Load Balancer. The `-sS` option specifies a SYN scan, `-p 80` targets port 80, `--source-port 54321` sets an arbitrary source port, `-e eth0` sets the network interface and `-S 10.0.0.10` spoofs the source IP.  `sudo` is generally required for raw packet sending.
    *   **Expected Output:** `nmap` will report whether the port is open, filtered, or closed. An open port indicates the Load Balancer is accepting connections.  The crucial part is that the *destination* pod sees the source IP as 10.0.0.10 if the spoof is successful.  To verify this, you must check the logs of the application running inside the pod (see below).
    *   **Purpose:** This tests if the Load Balancer forwards packets with the spoofed source IP.

5.  **Verify Source IP at Pod Level (Check Application Logs):**

    ```bash
    kubectl exec -it <pod_name> -n <namespace> -- tail -f /var/log/<application_log_file>
    ```

    Access the target pod's logs and check if the incoming request is logged with the spoofed IP address (`10.0.0.10`).  You might need to adapt this command based on your specific application logging configuration.

    *   **Explanation:** Connects to a running pod and tails the application's log file. Replace `<pod_name>`, `<namespace>` and `<application_log_file>` with the actual values.  The `--` separator ensures that arguments following it are passed to the `tail` command inside the container.
    *   **Expected Output:** The log file should show entries with the source IP address as `10.0.0.10` when the Load Balancer forwards the request with the spoofed source IP.
    *   **Purpose:** This *confirms* that the spoofed IP is making its way to the application running inside the Kubernetes cluster.  If the application sees the spoofed IP, then the vulnerability is validated.

**Phase 3: Exploitation (Bypassing Authentication)**

Assuming the application has an authentication mechanism based on source IP:

6.  **Craft an HTTP Request with Spoofed IP (using `hping3`)**:

    ```bash
    sudo hping3 -S -p 80 --data 0 --spoof 10.0.0.10 <load_balancer_ip>
    ```

    This sends a SYN packet to the Load Balancer, spoofing the source IP.  Next, we send an HTTP GET request to trigger application logic.

    ```bash
    sudo hping3 -p 80 --tcp-flags PUSH+ACK --data "GET /admin HTTP/1.0\r\n\r\n" --spoof 10.0.0.10 <load_balancer_ip>
    ```

    *   **Explanation:**  `hping3` is used to craft a TCP packet with the spoofed source IP. The `-S` flag sends a SYN packet (for initial handshake), `-p 80` sets the destination port, `--data` specifies the payload, `--spoof` sets the spoofed source IP address, and `<load_balancer_ip>` is the target IP of the Load Balancer. The second `hping3` command constructs a PUSH+ACK packet with an HTTP GET request for `/admin`, attempting to access an administrative resource.
    *   **Expected Output:** If successful, the application will process the HTTP request as if it originated from `10.0.0.10`, and potentially grant unauthorized access. Check the response received and the application logs. You might need to observe network traffic to see the response if it is not directly printed.
    *   **Purpose:** This step attempts to exploit the trust relationship based on source IP.  The `/admin` endpoint is just an example; it depends on your target application.

7.  **Verify Unauthorized Access (Check Application Logs and Responses):**

    Repeat step 5 (accessing the pod's logs) to confirm that the HTTP request with the spoofed IP was processed.  Analyze the application's response.  If the application granted access to the `/admin` endpoint or performed an action that should have been restricted, the vulnerability is successfully exploited.

    *   **Explanation:** This step verifies that the exploitation attempt was successful.
    *   **Expected Output:** The application logs will show that the HTTP request from the spoofed IP was processed, potentially leading to unauthorized access. The response should confirm whether the access control was bypassed.

**Potential Variations and Alternative Approaches:**

*   **Using `scapy` for more complex packet crafting:**  `scapy` provides a more flexible and powerful packet crafting tool. It can be used to create custom TCP/IP packets with arbitrary headers and payloads.
*   **Targeting Different Services:** The exploitation steps can be adapted to target different services or endpoints within the Kubernetes cluster.
*   **Experimenting with Different Spoofed IPs:**  Try different IP addresses to see if other IPs are considered "trusted" by the application.
*   **Using tools like `mitmproxy` in conjunction with spoofing:**  Setup `mitmproxy` to intercept traffic destined for the Load Balancer, then use packet crafting techniques to alter the source IP. This can be useful for more advanced exploitation scenarios.

**Remediation Recommendations:**

*   **Implement Kubernetes Network Policies:** Configure Network Policies to restrict traffic to the Load Balancer's IP range, preventing external IPs from directly reaching the pods.  Specifically, create Network Policies that only allow ingress traffic from the Load Balancer's IP address or a specific CIDR block it belongs to.
*   **Load Balancer Configuration:** Configure the Load Balancer to insert the real client IP address into the `X-Forwarded-For` header and to validate the incoming source IP addresses.  Ensure that the Load Balancer itself is configured to prevent spoofed traffic.
*   **Application-Level Validation:**  Implement robust authentication and authorization mechanisms at the application level. *Never rely solely on the source IP address for authentication or authorization*. Use strong authentication methods like API keys, JWTs, or OAuth.
*   **Input Validation:** Perform thorough input validation to prevent injection attacks and other vulnerabilities that could be exploited in conjunction with IP spoofing.
*   **Monitor and Alert:** Implement monitoring and alerting to detect suspicious activity, such as unusual traffic patterns or attempts to access restricted resources from unexpected IP addresses.
*   **Regular Security Audits:** Conduct regular security audits and penetration testing to identify and address vulnerabilities in the Kubernetes environment.
*   **Consider using Service Mesh:**  Service meshes like Istio can provide advanced traffic management and security features, including mutual TLS authentication, which can help prevent IP spoofing attacks.
*   **Use a Web Application Firewall (WAF):**  Deploy a WAF in front of the Load Balancer to filter malicious traffic and protect against common web application attacks.

By following these remediation recommendations, organizations can significantly reduce the risk of source IP address spoofing attacks in their Kubernetes environments.
