
# Kubernetes Capability Abuse for Privilege Escalation

## 1. Overview

This document outlines the vulnerability of leveraging Kubernetes capabilities granted to containers for privilege escalation. By exploiting certain capabilities, an attacker can gain root access to the container and potentially escape to the underlying node.

### Attack Vector Description

The attack vector involves identifying containers with overly permissive capabilities assigned to them. These capabilities, designed to grant specific privileges without requiring full root access, can be abused to escalate privileges to root or gain unauthorized access to the host system. Common capabilities used in this attack include `CAP_SYS_ADMIN`, `CAP_NET_RAW`, `CAP_DAC_OVERRIDE`, and `CAP_DAC_READ_SEARCH`.

### Potential Impact and Consequences

Successful exploitation can lead to:

*   **Container Compromise:** Complete control over the compromised container.
*   **Data Exfiltration:** Unauthorized access and exfiltration of sensitive data residing within the container.
*   **Lateral Movement:** Using the compromised container as a pivot point to attack other services and nodes within the cluster.
*   **Node Compromise:** Escaping the container and gaining root access to the underlying node.
*   **Cluster Takeover:** Potential for full cluster compromise if the node provides access to cluster-wide resources.

### Risk Level Assessment

**High**

The risk is high because the vulnerability allows for immediate privilege escalation and potential cluster-wide compromise. The effort required to exploit this vulnerability can be low, especially if containers are misconfigured with dangerous capabilities.

### Technical Explanation

Kubernetes allows assigning Linux capabilities to containers, providing granular control over the privileges they possess. However, misconfiguration can lead to security vulnerabilities.

*   **Capabilities as a Replacement for Root:** Capabilities were designed to replace the need for running processes as root.
*   **Overly Permissive Capabilities:** Granting capabilities like `CAP_SYS_ADMIN` effectively grants near-root privileges within the container.  `CAP_SYS_ADMIN` allows a container to perform many system administration functions, including mounting file systems.  This is often the easiest path to escape a container.
*   **Container Escape:**  Once `CAP_SYS_ADMIN` or a similar powerful capability is obtained, an attacker can leverage it to escape the container by mounting the host's root filesystem and modifying files.

### Prerequisites and Conditions Needed

*   Access to a Kubernetes cluster (e.g., via `kubectl`).
*   A running container with at least one exploitable capability assigned to it (e.g., `CAP_SYS_ADMIN`, `CAP_NET_RAW`, `CAP_DAC_OVERRIDE`).
*   Basic understanding of Linux capabilities and containerization concepts.
*   `kubectl` configured and authenticated to the cluster.

## 2. Validation and Exploitation Steps

The following steps outline how to validate and exploit a container with the `CAP_SYS_ADMIN` capability to achieve container escape and gain root access to the underlying node.

**Step 1: Identify Pods with Excessive Capabilities**

This step identifies pods that are running with elevated privileges, specifically looking for `CAP_SYS_ADMIN`.

```bash
kubectl get pods --all-namespaces -o json | jq '.items[] | select(.spec.containers[].securityContext.capabilities.add[] == "SYS_ADMIN") | .metadata.name + " (" + .metadata.namespace + ")" '
```

**Explanation:**

*   `kubectl get pods --all-namespaces -o json`: Retrieves all pods in all namespaces in JSON format.
*   `jq '.items[] | ...'`: Iterates through each item in the `items` array (each pod).
*   `select(.spec.containers[].securityContext.capabilities.add[] == "SYS_ADMIN")`: Filters for pods that have the `CAP_SYS_ADMIN` capability in at least one of their containers.
*   `.metadata.name + " (" + .metadata.namespace + ")"`: Extracts the pod name and namespace and combines them into a string for easy identification.

**Expected Output:**

A list of pod names and their namespaces that have the `CAP_SYS_ADMIN` capability. For example:

```
"vulnerable-pod (default)"
```

**Validation:**

This output confirms that a pod named `vulnerable-pod` in the `default` namespace has the `CAP_SYS_ADMIN` capability.

**Step 2: Get Shell Access to the Vulnerable Pod**

Now that we've identified a vulnerable pod, let's get a shell inside the container to perform further investigation.

```bash
kubectl exec -it vulnerable-pod -n default -- bash
```

**Explanation:**

*   `kubectl exec -it vulnerable-pod`:  Executes a command inside the `vulnerable-pod` container.
*   `-n default`: Specifies the namespace the pod is in.
*   `-- bash`: Executes the `bash` shell inside the container.  If `bash` isn't available, try `sh`.

**Expected Output:**

A shell prompt inside the container.

**Validation:**

Successfully entering the container confirms you have access to it.

**Step 3: Attempt Container Escape (Mount Host Filesystem)**

Within the container, we will attempt to mount the host's root filesystem.

```bash
mkdir /hostfs
mount --make-shared /
mount -t proc proc /hostfs/proc
mount -t sysfs sys /hostfs/sys
mount --bind / /hostfs
mount --make-rslave /hostfs
```

**Explanation:**

*   `mkdir /hostfs`: Creates a directory called `hostfs` inside the container. This will be the mount point for the host's filesystem.
*   `mount --make-shared /`:  Makes the root filesystem of the container shared.  This is necessary for propagation of mount events to the host.
*   `mount -t proc proc /hostfs/proc`: Mounts the host's `/proc` filesystem inside the container under `/hostfs/proc`.
*   `mount -t sysfs sys /hostfs/sys`: Mounts the host's `/sys` filesystem inside the container under `/hostfs/sys`.
*   `mount --bind / /hostfs`:  Mounts the host's root filesystem at /hostfs within the container. This is the core step in the container escape.
*   `mount --make-rslave /hostfs`: Configures the mount as a 'rslave' to isolate mount propagation.  This avoids potential loop issues and cleans up the mount.

**Expected Output:**

If the commands succeed, there will be no error messages.  You can then list the contents of `/hostfs` to verify that it contains the files and directories from the host's root filesystem.

**Validation:**

Execute the following command to verify the escape:

```bash
ls /hostfs
```

If you see the root directory contents (e.g., `boot`, `etc`, `var`, `usr`), the escape was successful.

**Step 4: Modify a File on the Host (Verification)**

To confirm you have write access to the host's filesystem, modify a file.  A less disruptive option is to create a file in `/tmp`

```bash
echo "PWNED" > /hostfs/tmp/pwned.txt
```

**Explanation:**

*   `echo "PWNED" > /hostfs/tmp/pwned.txt`: Writes the string "PWNED" to a file named `pwned.txt` in the `/tmp` directory on the host filesystem (accessed through `/hostfs/tmp`).

**Expected Output:**

No output if successful.

**Validation:**

Exit the container shell and check the host filesystem for the created file.  Since you likely do not have shell access to the node, you will need to find another way to confirm (e.g., inspecting the file from another container mounted on the host, or accessing it through a persistent volume).

**Step 5:  Potential Further Exploitation (If applicable)**

From this point, further exploitation is possible, including:

*   Adding a new user to the host with root privileges.
*   Installing malware on the host.
*   Accessing sensitive data stored on the host.

## Remediation Recommendations

*   **Principle of Least Privilege:**  Grant only the necessary capabilities to containers. Avoid using `CAP_SYS_ADMIN` unless absolutely essential.
*   **Pod Security Policies (PSP) / Pod Security Admission (PSA):** Use PSP or PSA to restrict the capabilities that can be requested by pods.  Define policies that prevent pods from requesting dangerous capabilities like `CAP_SYS_ADMIN`.
*   **Runtime Security:**  Implement runtime security tools (e.g., Falco, Aqua Security) to detect and prevent suspicious activity within containers, including attempts to exploit capabilities.
*   **Regular Audits:** Regularly audit the capabilities assigned to containers to ensure they are still necessary and appropriate.
*   **Image Scanning:** Scan container images for known vulnerabilities and misconfigurations before deploying them to the cluster.
*   **Immutable Infrastructure:** Deploy containers from immutable images to prevent malicious modifications to the container filesystem.
