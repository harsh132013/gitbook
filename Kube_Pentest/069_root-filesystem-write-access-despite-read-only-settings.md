
# Kubernetes Vulnerability: Root Filesystem Write Access Despite Read-Only Settings

## 1. Overview Section

This vulnerability allows an attacker to bypass configured read-only root filesystem settings and gain write access, potentially leading to container breakout, privilege escalation, and compromise of the node or cluster.

**Attack Vector Description:**

The attacker exploits inconsistencies or misconfigurations in how read-only filesystems are enforced within the container runtime. This can involve leveraging weaknesses in how volumes are mounted, utilizing writable mounts despite root being read-only, or exploiting loopholes in filesystem restrictions.  The attacker aims to find or create a writable path within the container to modify critical system files or execute arbitrary code.

**Potential Impact and Consequences:**

*   **Container Breakout:** Modifying sensitive files or executables allows the attacker to escape the container and gain access to the underlying node.
*   **Privilege Escalation:** Gaining write access to system binaries or configuration files allows the attacker to escalate privileges within the container or on the node.
*   **Arbitrary Code Execution:** Writing malicious code to accessible locations allows the attacker to execute arbitrary commands.
*   **Data Exfiltration/Tampering:**  Gaining write access to the filesystem allows the attacker to steal sensitive data or modify application data.
*   **Denial of Service:**  Modifying system files can cause the container or node to become unstable, leading to denial of service.

**Risk Level Assessment:** Critical

**Technical Explanation of Why This Vulnerability Exists:**

The vulnerability arises due to several factors:

*   **Incorrect Volume Mounting:** Kubernetes volumes might be misconfigured, allowing writable volumes to be mounted even when the root filesystem is intended to be read-only. This is particularly common when using hostPath volumes or improperly configured emptyDir volumes.
*   **Mutable Directories within Read-Only Root:**  Certain directories like `/tmp` or `/dev/shm` are often writable even in containers with read-only root filesystems.  An attacker can exploit this if they can write executable code to these locations and then execute it.
*   **Cgroups/Namespaces Escapes:** In some instances, vulnerabilities in the container runtime environment might allow an attacker to break out of the container's cgroups or namespaces, providing access to the underlying node's filesystem. While less common, this is a highly impactful scenario.
*   **Docker/Containerd Vulnerabilities:** Bugs or misconfigurations in the underlying container engine can sometimes lead to this scenario.
*   **Kernel Exploits:** In rare cases, a kernel exploit within the container can grant unintended write access to the root filesystem.

**Prerequisites and Conditions Needed:**

*   A Kubernetes cluster or environment to test against.
*   A container deployed with a configuration intending to enforce a read-only root filesystem ( `securityContext: readOnlyRootFilesystem: true` in the pod spec).
*   Access to the container's shell, which can be achieved through `kubectl exec` or other debugging tools.
*   Basic knowledge of Kubernetes, containerization, and Linux filesystems.
*   A persistent volume mount that is misconfigured and writable.

## 2. Validation and Exploitation Steps Section

This section outlines the steps to validate and exploit the root filesystem write access vulnerability.  We assume a pod is running with `securityContext: readOnlyRootFilesystem: true`.

**Phase 1: Validation - Identifying Writable Locations**

1.  **Access the Container Shell:**

    ```bash
    kubectl exec -it <pod_name> -- /bin/bash
    ```

    *   **Explanation:** This command connects to a running pod and launches an interactive bash shell inside the container. Replace `<pod_name>` with the name of the pod you want to investigate.
    *   **Why:**  We need access to the container's shell to inspect the filesystem and attempt to write files.
    *   **Expected Output:**  A bash shell prompt within the container (e.g., `root@<pod_name>:/#`).
    *   **Contributes to:** Provides the necessary environment to conduct further investigation.
    *   **Alternative:** If `/bin/bash` is not available, try `/bin/sh`, `/bin/ash`, or `/sh`.

2.  **Test Write Access to Root Directory:**

    ```bash
    touch /test_file
    ```

    *   **Explanation:** This command attempts to create a file named `test_file` in the root directory (`/`).
    *   **Why:**  This is a basic test to quickly determine if the root filesystem is truly read-only.
    *   **Expected Output:** If the root filesystem is truly read-only: `touch: cannot touch '/test_file': Read-only file system`.  If successful (vulnerability present), no error message is displayed.
    *   **Contributes to:**  Provides immediate feedback on the overall read-only enforcement. If this succeeds, the vulnerability is obvious.

3.  **Check Known Writable Directories:**

    ```bash
    touch /tmp/test_file
    touch /dev/shm/test_file
    ```

    *   **Explanation:** This attempts to create files in commonly writable directories.
    *   **Why:** These directories are often writable even with `readOnlyRootFilesystem: true`.  We're looking for writable paths that could be leveraged.
    *   **Expected Output:** If successful, no errors are reported. If read-only: `touch: cannot touch '/tmp/test_file': Read-only file system`.
    *   **Contributes to:**  Identifies specific writable paths for potential exploitation.

4.  **Identify Mounted Volumes:**

    ```bash
    mount | grep -v ro
    ```

    *   **Explanation:** This command lists all mounted filesystems and filters out those explicitly mounted as read-only (`-v ro`).
    *   **Why:**  We're looking for any mounted volumes that are writable, as these represent potential bypasses to the read-only root filesystem.
    *   **Expected Output:** A list of mount points and their corresponding devices/sources that are *not* read-only. Look for volumes mounted from the host filesystem (e.g., using `hostPath`).  Examine each mount to identify it.
    *   **Contributes to:** Helps identify potentially writable volumes that could be exploited.
    *   **Alternative:** `df -h` can also provide information about mounted volumes and their sizes.

5. **Inspect all volumes and test for writing:**

    ```bash
    mount | awk '{print $3}' | grep '^/' | while read mount_point; do
        echo "Testing write access to: $mount_point"
        if touch "$mount_point/test_file" 2>/dev/null; then
            echo "Successfully wrote to: $mount_point/test_file"
            rm "$mount_point/test_file"
        else
            echo "Failed to write to: $mount_point"
        fi
    done
    ```

    *   **Explanation:** This script iterates through each mount point and attempts to create a `test_file` within it.  It reports whether the write was successful.
    *   **Why:** This automatically iterates over all likely mount points to test for write access.  It handles errors silently so it can iterate correctly.
    *   **Expected Output:** Output showing whether each mountpoint is writable.
    *   **Contributes to:** Comprehensive discovery of writable mounted volumes.
    *   **Alternative:** Adapt the script to write to other locations, such as a temporary directory within the mount point if the top level directory is restricted.

**Phase 2: Exploitation - Modifying System Files (Example Scenario: hostPath Volume)**

This example assumes a `hostPath` volume is writable inside the container.  The exact steps will vary depending on the discovered writable volume and its contents.

1. **Locate a Suitable Target:** Assume `/mnt/hostpath` is a writable `hostPath` volume, pointing to `/opt/data` on the host, and that we want to modify `/etc/passwd` on the host. This is a *highly dangerous* scenario and should only be performed in a controlled, isolated test environment.

2.  **Backup Target File:**

    ```bash
    cp /mnt/hostpath/etc/passwd /mnt/hostpath/etc/passwd.bak
    ```

    *   **Explanation:** This creates a backup of the target file before modification.
    *   **Why:**  Protects against accidental damage and allows restoration.
    *   **Expected Output:** No error if successful.

3.  **Modify the Target File:**

    ```bash
    echo "attacker:x:0:0:root:/root:/bin/bash" >> /mnt/hostpath/etc/passwd
    ```

    *   **Explanation:** This command appends a malicious user account to the `passwd` file on the *host*.
    *   **Why:** This is a classic method to gain root access to the node.
    *   **Expected Output:** No error if successful. The `/etc/passwd` file on the host will now contain a new user account.
    *   **Contributes to:** Introduces a backdoor for node access.
    *   **WARNING:** This command is highly dangerous and should only be used in a controlled environment. Incorrect modification of `/etc/passwd` can render the system unusable.

4.  **Verify the Modification (on the HOST):**

   ```bash
   # On the Host Node:
   cat /opt/data/etc/passwd | grep attacker
   ```

   *   **Explanation:** This confirms that the attacker account was successfully added to the host's `/etc/passwd` file. This step is performed *outside* the container, on the host system.
   *   **Why:**  Confirms the successful exploitation of the vulnerability and proves the ability to modify the host filesystem.
   *   **Expected Output:**  `attacker:x:0:0:root:/root:/bin/bash`
   *   **Contributes to:** Validates the successful execution of the exploit.

**Alternative Exploitation Scenarios:**

*   **Modifying systemd services:** An attacker can modify systemd service files within the writable volume to execute malicious code when the service starts.
*   **Overwriting binaries:** An attacker can replace existing binaries with malicious ones, leading to privilege escalation when those binaries are executed.
*   **Data theft:** An attacker can exfiltrate sensitive data to a writable volume for later retrieval.

**Remediation Recommendations:**

*   **Enforce Read-Only Root Filesystems:** Properly configure `securityContext: readOnlyRootFilesystem: true` in pod specifications.  Ensure that your container images are built following security best practices.
*   **Minimize Writable Volumes:**  Avoid using writable `hostPath` volumes unless absolutely necessary. If required, restrict the permissions of the mounted directories.
*   **Use Pod Security Policies (PSP) or Pod Security Admission (PSA):** PSPs or PSAs allow you to enforce security policies at the cluster level, preventing containers from being deployed with vulnerable configurations.  Use them to disallow writable `hostPath` mounts, among other restrictions.
*   **Implement AppArmor or Seccomp Profiles:** These tools can restrict the capabilities of containers, limiting the potential impact of a successful exploit.
*   **Regularly Scan Container Images:** Use a vulnerability scanner to identify and address security issues in your container images.
*   **Monitor and Audit Container Activity:**  Implement logging and monitoring to detect suspicious activity within containers.
*   **Principle of Least Privilege:**  Grant only the necessary permissions to containers and users.
*   **Patch Regularly:** Keep your Kubernetes cluster, container runtime, and operating system up to date with the latest security patches.
*   **Review volume claims for write permissions:** Look for any volume claims that allow write access.
*   **Use immutable infrastructure principles:**  If possible, build containers that avoid writing to the local filesystem.

**Important Notes:**

*   This documentation is for educational and ethical penetration testing purposes only.  Unauthorized access to or modification of systems is illegal and unethical.
*   Always obtain proper authorization before conducting penetration tests.
*   Be extremely cautious when modifying system files, as incorrect modifications can lead to system instability.
*   This is not an exhaustive list of all possible exploitation scenarios. The specific steps required to exploit this vulnerability will depend on the specific environment and configuration.
