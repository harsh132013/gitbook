
# Kubernetes RBAC Wildcard Permission Abuse

## 1. Overview Section

**Attack Vector Description:**

The RBAC (Role-Based Access Control) system in Kubernetes controls access to resources. Wildcard permissions, denoted by `*`, are often used to grant broad access. However, over-permissive wildcard rules can be abused by attackers to escalate privileges and gain unauthorized control over the cluster. This vulnerability occurs when a user or service account is granted a role that includes wildcards for resources they shouldn't have access to, allowing them to perform actions far beyond their intended scope.

**Potential Impact and Consequences:**

*   **Complete Cluster Compromise:** An attacker can gain full control of the Kubernetes cluster, including the ability to create, modify, and delete any resource.
*   **Data Exfiltration:** Sensitive data stored within the cluster (e.g., secrets, application data) can be accessed and exfiltrated.
*   **Service Disruption:** The attacker can disrupt services by deleting deployments, pods, or other critical resources.
*   **Privilege Escalation:**  An attacker with limited access can escalate their privileges to become a cluster administrator.
*   **Malware Deployment:** An attacker can deploy malicious containers or workloads into the cluster.

**Risk Level Assessment:**

**Critical** - The potential impact includes complete cluster compromise, making this a high-severity vulnerability.

**Technical Explanation of Why This Vulnerability Exists:**

The vulnerability stems from overly permissive RBAC configurations.  Kubernetes RBAC uses Roles and ClusterRoles to define permissions, and RoleBindings and ClusterRoleBindings to grant these permissions to users, groups, or service accounts.  When wildcard permissions are used without careful consideration of the scope, a user with limited privileges can inadvertently gain access to sensitive resources. The Kubernetes API server relies on the RBAC system to enforce access control, and it will grant access based on the defined rules, even if those rules are overly permissive. This is further compounded when the attacker can create resources to exploit the granted wildcards.

**Prerequisites and Conditions Needed:**

*   **Existing RBAC configuration:** There must be an existing RBAC setup with Roles/ClusterRoles bound to users or service accounts.
*   **Over-permissive wildcard permissions:**  At least one Role or ClusterRole must contain wildcard permissions (e.g., `resources: ["*"]`, `verbs: ["*"]`) that grant access to sensitive resources beyond the intended scope.
*   **Access to a user or service account with a vulnerable binding:** The attacker needs to have access to a user or service account that is bound to a Role or ClusterRole containing the over-permissive wildcard permissions. This could be achieved through stolen credentials, exploiting an existing vulnerability in an application running within the cluster, or social engineering.
*   **kubectl configured and authenticated:**  The attacker must have `kubectl` configured and authenticated to the Kubernetes cluster using the credentials of the vulnerable user or service account.

## 2. Validation and Exploitation Steps Section

This section demonstrates how to validate and exploit RBAC wildcard permission abuse in Kubernetes. We assume the attacker has access to a service account named `test-user` in the namespace `test-ns` and kubectl is configured to use the `test-user`'s credentials.

**Step 1: Validate the Service Account's Initial Permissions**

```bash
kubectl auth can-i --list --as=system:serviceaccount:test-ns:test-user --namespace=test-ns
```

**Explanation:** This command checks what actions the `test-user` service account in the `test-ns` namespace is authorized to perform. `--as=system:serviceaccount:test-ns:test-user` specifies the identity to impersonate for the authorization check. `--list` will show all permissions that service account possesses.

**Expected Output:** The output will list the resources and verbs the service account is authorized to use. Initially, it should show limited permissions, reflecting the intended scope. For example, before exploiting a wildcard, it might show access only to pods in a specified namespace and read access to certain resources. Examine the output to understand the initial state.

**Why:** This step establishes a baseline to compare against after potential privilege escalation.

**Step 2: Identify Potentially Abusable Wildcard Permissions**

This step involves examining the RBAC configuration to identify Roles or ClusterRoles that grant wildcard permissions to the `test-user`.  This requires knowing which roles/clusterroles are bound to the service account `test-user`.  Assume, for this example, that `test-user` is bound to a `ClusterRole` called `test-cluster-role`.

```bash
kubectl get clusterrole test-cluster-role -o yaml
```

**Explanation:**  This command retrieves the YAML definition of the `test-cluster-role` ClusterRole.  We are looking for lines that contain `resources: ["*"]` or `verbs: ["*"]`.

**Expected Output:** YAML output showing the rules of the `test-cluster-role`. Specifically, look for rules with `resources: ["*"]` and/or `verbs: ["*"]`. If you see something like:

```yaml
rules:
- apiGroups:
  - '*'
  resources:
  - '*'
  verbs:
  - '*'
```

This indicates a highly exploitable wildcard permission.

**Why:**  This step identifies the source of the vulnerability - the over-permissive wildcard rules.

**Step 3: Attempt to Create a ClusterRoleBinding**

```bash
kubectl create clusterrolebinding escalate-privs --clusterrole=cluster-admin --serviceaccount=test-ns:test-user
```

**Explanation:** This command attempts to create a ClusterRoleBinding that grants the `cluster-admin` ClusterRole to the `test-user` service account. If the `test-user` has the necessary permissions due to a wildcard, this command will succeed.

**Expected Output:**

*   **Successful Execution (Vulnerable):** If the command succeeds, it confirms that the `test-user` has the necessary permissions to create ClusterRoleBindings, which is a clear indicator of privilege escalation. You'll see output similar to: `clusterrolebinding.rbac.authorization.k8s.io/escalate-privs created`
*   **Error (Not Vulnerable):** If the command fails with an authorization error (e.g., "forbidden: User ... cannot create clusterrolebindings.rbac.authorization.k8s.io in the cluster scope"), it indicates that the `test-user` does not have the necessary permissions.

**Why:**  This is a direct attempt to escalate privileges to cluster administrator.

**Step 4: Validate Increased Permissions**

```bash
kubectl auth can-i --list --as=system:serviceaccount:test-ns:test-user --namespace=test-ns
```

**Explanation:**  This is the same command as Step 1, but executed after attempting to escalate privileges.

**Expected Output:** The output should now show that the `test-user` has access to perform any action on any resource.  This confirms that the privilege escalation was successful. Look for output showing access to core resources with `verbs: ["*"]`.

**Why:** This step confirms that the `test-user` now has cluster-admin level privileges.

**Step 5: (Exploitation) Deploy a Malicious Pod**

Now that `test-user` has cluster-admin privileges, deploy a malicious pod to demonstrate the impact. This pod will be configured to run in the host network namespace, giving it access to the host's network interfaces.

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: malicious-pod
  namespace: default
spec:
  hostNetwork: true
  containers:
  - name: malicious-container
    image: alpine/socat
    command: ["/bin/sh", "-c", "while true; do nc -l -p 8000 > /dev/null; done"]
EOF
```

**Explanation:** This command deploys a Pod named `malicious-pod` in the `default` namespace.  `hostNetwork: true` makes the pod use the host's network namespace. The container runs a `socat` process that listens on port 8000, effectively creating a port forward on the host. This could be used to intercept traffic or perform other malicious actions on the host network.  A more sophisticated attack could involve accessing sensitive files on the host or injecting malicious code into other processes.

**Expected Output:**

*   **Successful Deployment:** The pod should be created and running.  You can verify this with `kubectl get pods -n default`.
*   **Network Access:**  The `malicious-pod` now has access to the host's network interfaces and can potentially intercept traffic.

**Why:**  This demonstrates a real-world attack scenario enabled by the escalated privileges.

**Step 6: (Exploitation) Access Secrets in Other Namespaces**

```bash
kubectl get secrets --all-namespaces
```

**Explanation:** Because the user now has cluster-admin permissions, this command allows the user to list all secrets in the Kubernetes cluster across all namespaces. This is an example of data exfiltration.

**Expected Output:** A full list of secrets across all namespaces within the Kubernetes cluster. This includes sensitive information like API keys, passwords, and tokens.

**Why:** This command demonstrates how an attacker can gain access to sensitive information stored in the cluster by exploiting the escalated privileges.

**Remediation Recommendations:**

*   **Least Privilege Principle:**  Grant only the minimum necessary permissions to users and service accounts.  Avoid using wildcards whenever possible.
*   **Role-Based Access Control (RBAC) Auditing:** Regularly review and audit RBAC configurations to identify overly permissive rules.  Use tools like `kube-hunter` to identify potential misconfigurations.
*   **Restrict Wildcard Usage:** If wildcard permissions are necessary, limit their scope as much as possible.  For example, grant wildcard permissions only for specific resources within a particular namespace.
*   **Policy Enforcement:** Implement policy enforcement tools like OPA (Open Policy Agent) or Kyverno to enforce RBAC policies and prevent the creation of overly permissive roles and bindings.
*   **Pod Security Policies/Pod Security Standards:** Use Pod Security Policies or Pod Security Standards to restrict the capabilities of containers, such as preventing them from running in the host network namespace.
*   **Regular Security Scans:** Conduct regular vulnerability scans of your Kubernetes cluster to identify and address potential security issues.

This comprehensive guide provides a detailed understanding of RBAC wildcard permission abuse in Kubernetes, including validation and exploitation techniques, as well as remediation recommendations. This information will assist penetration testers in identifying and mitigating this critical vulnerability.
